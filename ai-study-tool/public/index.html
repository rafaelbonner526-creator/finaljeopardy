<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Study Tool (Jeopardy v5)</title>
<style>
  :root {
    --blue-dark: #001f3f;
    --blue-mid: #0b52b3;
    --blue-light: #3498db;
    --accent: #ffd700;
    --success: #2ecc71;
    --error: #e74c3c;
  }

  body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(145deg, var(--blue-dark), #012a63);
    color: #fff;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  h1 {
    text-align: center;
    font-size: 2rem;
    color: var(--accent);
    letter-spacing: 1px;
    text-shadow: 0 0 8px rgba(255,215,0,0.5);
  }

  #score {
    text-align: center;
    font-size: 1.3rem;
    margin-top: 5px;
    transition: 0.3s ease;
  }

  #board {
    display: grid;
    gap: 15px;
    margin-top: 30px;
  }

  .category-column {
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }

  .category-title {
    background: var(--blue-mid);
    padding: 12px;
    text-align: center;
    border-radius: 8px;
    font-weight: 700;
    color: white;
    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
  }

  .tile {
    background: var(--blue-light);
    margin-top: 10px;
    padding: 25px;
    border-radius: 8px;
    text-align: center;
    font-size: 22px;
    cursor: pointer;
    transition: all 0.25s ease;
  }
  .tile:hover {
    transform: scale(1.05);
    background: #3aa7ff;
  }
  .tile.used {
    background: #333;
    cursor: default;
    opacity: 0.6;
  }

  #modal, #match-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(4px);
    z-index: 999;
  }

  .card {
    background: #fff;
    color: #111;
    padding: 25px;
    border-radius: 10px;
    width: 95%;
    max-width: 600px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    transform: scale(0.95);
    opacity: 0;
    animation: popIn 0.3s forwards;
  }

  @keyframes popIn {
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  textarea {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ddd;
    margin-top: 10px;
    resize: none;
  }

  button {
    margin-top: 12px;
    padding: 10px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.25s ease;
  }

  #continueBtn, #submit {
    background: var(--blue-mid);
    color: #fff;
  }
  #continueBtn:hover, #submit:hover {
    background: var(--blue-light);
  }
  #close {
    background: #ccc;
  }
  #close:hover {
    background: #aaa;
  }

  #prePrompt {
    background: #f0f8ff;
    color: #000;
    padding: 15px;
    border-left: 5px solid var(--blue-light);
    border-radius: 6px;
    margin-bottom: 10px;
    font-style: italic;
    line-height: 1.4;
  }

  #feedback {
    margin-top: 15px;
    padding: 12px;
    border-radius: 8px;
    transition: 0.3s;
  }
  #feedback.correct { background: #d1fae5; color: #065f46; }
  #feedback.incorrect { background: #fee2e2; color: #991b1b; }
  #feedback.partial { background: #fff3cd; color: #856404; }

  #dropdowns select {
    width: 100%;
    margin: 6px 0;
    padding: 8px;
    border-radius: 4px;
  }

  .slide-up {
    animation: slideUp 0.4s ease forwards;
  }
  @keyframes slideUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
</style>
</head>
<body>
<h1>AI Study Tool (Jeopardy Edition)</h1>
<div id="score">Score: 0</div>
<div id="board"></div>

<div id="modal">
  <div class="card">
    <div id="prePrompt" style="display:none;"></div>
    <div id="question-text" style="display:none;font-weight:600;font-size:18px;"></div>
    <textarea id="answer" rows="3" placeholder="Type your answer here..." style="display:none;"></textarea>
    <div id="button-area">
      <button id="continueBtn" style="display:none;">Continue to Question</button>
      <button id="submit" style="display:none;">Submit</button>
      <button id="close">Close</button>
    </div>
    <div id="feedback"></div>
  </div>
</div>

<div id="match-modal">
  <div class="card slide-up">
    <div id="match-question"></div>
    <div id="dropdowns"></div>
    <button id="submit-match">Submit Matches</button>
  </div>
</div>

<script>
let data={},score=0,currentQ=null,followUp=null;

async function loadBoard(){
  const res=await fetch("/api/questions");
  data=await res.json();
  const board=document.getElementById("board");
  const topics=Object.keys(data);
  board.style.gridTemplateColumns=`repeat(${topics.length},1fr)`;
  topics.forEach(topic=>{
    const col=document.createElement("div");
    col.className="category-column";
    const title=document.createElement("div");
    title.className="category-title"; title.textContent=topic;
    col.appendChild(title);
    data[topic].forEach(q=>{
      const tile=document.createElement("div");
      tile.className="tile"; tile.textContent=q.value;
      tile.onclick=()=>openQuestion(tile,q);
      col.appendChild(tile);
    });
    board.appendChild(col);
  });
}
function updateScore(){
  const scoreEl=document.getElementById("score");
  scoreEl.textContent=`Score: ${score}`;
  scoreEl.style.color="var(--accent)";
  setTimeout(()=>scoreEl.style.color="white",500);
}

function openQuestion(tile,q){
  if(tile.classList.contains("used"))return;
  currentQ={tile,q};
  const questionObj=q.questions[0];

  const modal=document.getElementById("modal");
  const prePrompt=document.getElementById("prePrompt");
  const questionText=document.getElementById("question-text");
  const answer=document.getElementById("answer");
  const continueBtn=document.getElementById("continueBtn");
  const submitBtn=document.getElementById("submit");
  const feedback=document.getElementById("feedback");

  prePrompt.style.display="none";
  questionText.style.display="none";
  answer.style.display="none";
  continueBtn.style.display="none";
  submitBtn.style.display="none";
  feedback.innerHTML="";

  if(questionObj.preQuestionPrompt){
    prePrompt.textContent=questionObj.preQuestionPrompt;
    prePrompt.style.display="block";
    continueBtn.style.display="inline-block";
    continueBtn.onclick=()=>{
      prePrompt.style.display="none";
      continueBtn.style.display="none";
      showQuestion(questionObj);
    };
  } else {
    showQuestion(questionObj);
  }

  modal.style.display="flex";
}

function showQuestion(questionObj){
  document.getElementById("question-text").textContent=questionObj.questionText;
  document.getElementById("question-text").style.display="block";
  document.getElementById("answer").style.display="block";
  document.getElementById("submit").style.display="inline-block";
}

async function submitAnswer(){
  const ans=document.getElementById("answer").value.trim();
  if(!ans){alert("Please enter an answer first.");return;}

  const res=await fetch("/api/evaluate",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({questionId:currentQ.q.questions[0].id,studentAnswer:ans})
  });
  const result=await res.json();

  const fb=document.getElementById("feedback");
  fb.className="";
  if(result.grade==="correct")fb.classList.add("correct");
  else if(result.grade==="partially correct")fb.classList.add("partial");
  else fb.classList.add("incorrect");

  fb.innerHTML=`<b>Grade:</b> ${result.grade.toUpperCase()}<br><b>Feedback:</b> ${result.feedback}<br><b>Correct:</b> ${result.correctAnswer}`;

  if(result.grade==="correct")score+=100;
  else if(result.grade==="partially correct")score+=50;
  updateScore();

  currentQ.tile.classList.add("used");

  await new Promise(resolve=>setTimeout(resolve,2000));

  fb.innerHTML+=`<br><button id='acknowledgeBtn'>Continue</button>`;
  document.getElementById("acknowledgeBtn").onclick=()=>{
    document.getElementById("modal").style.display="none";
    if(currentQ.q.questions[0].followUp){showMatch();}
  };
}

function showMatch(){
  const m=document.getElementById("match-modal");
  const q=document.getElementById("match-question");
  const dd=document.getElementById("dropdowns");
  followUp=currentQ.q.questions[0].followUp;
  q.textContent=followUp.question;
  dd.innerHTML="";
  const defs=followUp.pairs.map(p=>p.definition);
  followUp.pairs.forEach(p=>{
    const div=document.createElement("div");
    const sel=document.createElement("select");
    sel.className="option-select";
    const shuffled=[...defs].sort(()=>Math.random()-0.5);
    shuffled.forEach(opt=>{
      const o=document.createElement("option");
      o.value=opt;o.textContent=opt;sel.appendChild(o);
    });
    div.innerHTML=`<b>${p.term}</b>`;
    div.appendChild(sel);
    dd.appendChild(div);
  });
  m.style.display="flex";
}

document.getElementById("submit-match").onclick=()=>{
  const selects=document.querySelectorAll("#dropdowns select");
  let correct=0;
  selects.forEach((sel,i)=>{
    const chosen=sel.value;
    const correctDef=followUp.pairs[i].definition;
    if(chosen===correctDef){sel.classList.add("correct");correct++;}
    else sel.classList.add("incorrect");
  });
  score+=correct*20;
  updateScore();
  setTimeout(()=>{document.getElementById("match-modal").style.display="none";},2000);
};

document.getElementById("submit").onclick=submitAnswer;
document.getElementById("close").onclick=()=>document.getElementById("modal").style.display="none";
loadBoard();
</script>
</body>
</html>
