
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Study Tool (Jeopardy v4)</title>
<style>
body{font-family:sans-serif;background:#041e42;color:white;padding:20px;}
h1{text-align:center;}
#board{display:grid;gap:10px;margin-top:20px;}
.category-column{display:flex;flex-direction:column;align-items:stretch;}
.category-title{text-align:center;background:#003366;padding:10px;border-radius:4px;font-weight:bold;}
.tile{background:#0b52b3;margin-top:10px;padding:20px;border-radius:6px;text-align:center;font-size:20px;cursor:pointer;}
.tile.used{background:#333;cursor:default;opacity:0.7;}
#modal,#match-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);}
.card{background:white;color:black;padding:20px;border-radius:8px;width:90%;max-width:600px;}
textarea{width:100%;}
button{margin-top:10px;padding:8px 12px;border:none;border-radius:4px;cursor:pointer;}
#score{margin-top:10px;text-align:center;font-size:18px;}
.option-select{width:100%;margin:4px 0;}
.correct{background:#d1fae5;}
.incorrect{background:#fee2e2;}
</style>
</head>
<body>
<h1>AI Study Tool (Jeopardy Edition)</h1>
<div id="score">Score: 0</div>
<div id="board"></div>

<div id="modal">
  <div class="card">
    <div id="question-text"></div>
    <textarea id="answer" rows="3" placeholder="Type your answer here..."></textarea>
    <div><button id="submit">Submit</button> <button id="close">Close</button></div>
    <div id="feedback"></div>
  </div>
</div>

<div id="match-modal">
  <div class="card">
    <div id="match-question"></div>
    <div id="dropdowns"></div>
    <button id="submit-match">Submit Matches</button>
  </div>
</div>

<script>
let data={},score=0,currentQ=null,followUp=null;

async function loadBoard(){
  const res=await fetch("/api/questions");
  data=await res.json();
  const board=document.getElementById("board");
  const topics=Object.keys(data);
  board.style.gridTemplateColumns=`repeat(${topics.length},1fr)`;
  topics.forEach(topic=>{
    const col=document.createElement("div");
    col.className="category-column";
    const title=document.createElement("div");
    title.className="category-title"; title.textContent=topic;
    col.appendChild(title);
    data[topic].forEach(q=>{
      const tile=document.createElement("div");
      tile.className="tile"; tile.textContent=q.value;
      tile.onclick=()=>openQuestion(tile,q);
      col.appendChild(tile);
    });
    board.appendChild(col);
  });
}
function updateScore(){document.getElementById("score").textContent=`Score: ${score}`;}

function openQuestion(tile,q){
  if(tile.classList.contains("used"))return;
  currentQ={tile,q};
  document.getElementById("question-text").textContent=q.questions[0].questionText;
  document.getElementById("answer").value="";
  document.getElementById("feedback").innerHTML="";
  document.getElementById("modal").style.display="flex";
}

async function submitAnswer(){
  const ans=document.getElementById("answer").value;
  const res=await fetch("/api/evaluate",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({questionId:currentQ.q.questions[0].id,studentAnswer:ans})
  });
  const result=await res.json();
  const fb=document.getElementById("feedback");
  fb.innerHTML=`<b>Grade:</b> ${result.grade}<br><b>Feedback:</b> ${result.feedback}<br><b>Correct:</b> ${result.correctAnswer}`;
  if(result.grade==="correct")score+=100;
  else if(result.grade==="partially correct")score+=50;
  updateScore();
  currentQ.tile.classList.add("used");
  if(currentQ.q.questions[0].followUp){
    followUp=currentQ.q.questions[0].followUp;
    setTimeout(()=>{document.getElementById("modal").style.display="none";showMatch();},1500);
  }
}

function showMatch(){
  const m=document.getElementById("match-modal");
  const q=document.getElementById("match-question");
  const dd=document.getElementById("dropdowns");
  q.textContent=followUp.question;
  dd.innerHTML="";
  const defs=followUp.pairs.map(p=>p.definition);
  followUp.pairs.forEach(p=>{
    const div=document.createElement("div");
    const sel=document.createElement("select");
    sel.className="option-select";
    const shuffled=[...defs].sort(()=>Math.random()-0.5);
    shuffled.forEach(opt=>{
      const o=document.createElement("option");
      o.value=opt;o.textContent=opt;sel.appendChild(o);
    });
    div.innerHTML=`<b>${p.term}</b>`;
    div.appendChild(sel);
    dd.appendChild(div);
  });
  m.style.display="flex";
}

document.getElementById("submit-match").onclick=()=>{
  const selects=document.querySelectorAll("#dropdowns select");
  let correct=0;
  selects.forEach((sel,i)=>{
    const chosen=sel.value;
    const correctDef=followUp.pairs[i].definition;
    if(chosen===correctDef){sel.classList.add("correct");correct++;}
    else sel.classList.add("incorrect");
  });
  score+=correct*20;
  updateScore();
  setTimeout(()=>{document.getElementById("match-modal").style.display="none";},2000);
};

document.getElementById("submit").onclick=submitAnswer;
document.getElementById("close").onclick=()=>document.getElementById("modal").style.display="none";
loadBoard();
</script>
</body></html>
